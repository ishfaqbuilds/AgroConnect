<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login / Sign Up - AgroConnect</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #01161e 0%,
          #124559 50%,
          #598392 100%
        );
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .auth-container {
        display: flex;
        max-width: 1000px;
        width: 100%;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      /* Left Side - Branding */
      .auth-left {
        flex: 1;
        background: linear-gradient(135deg, #124559, #598392);
        padding: 3rem;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .brand-header {
        margin-bottom: 3rem;
      }

      .brand-logo {
        font-size: 3rem;
        margin-bottom: 0.5rem;
      }

      .brand-name {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .brand-tagline {
        font-size: 1rem;
        opacity: 0.9;
        margin-left: 4.5rem;
      }

      .features-list {
        list-style: none;
      }

      .feature-item {
        display: flex;
        align-items: start;
        margin-bottom: 2rem;
      }

      .feature-icon {
        font-size: 2rem;
        margin-right: 1rem;
      }

      .feature-content h3 {
        font-size: 1.3rem;
        margin-bottom: 0.3rem;
      }

      .feature-content p {
        opacity: 0.9;
        font-size: 0.95rem;
      }

      /* Right Side - Form */
      .auth-right {
        flex: 1;
        padding: 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .form-header {
        margin-bottom: 2rem;
      }

      .form-header h2 {
        font-size: 2rem;
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .form-header p {
        color: #7f8c8d;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 0.9rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #598392;
        box-shadow: 0 0 0 3px rgba(89, 131, 146, 0.1);
      }

      .remember-me {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .remember-me input {
        margin-right: 0.5rem;
      }

      .remember-me label {
        color: #7f8c8d;
        font-size: 0.9rem;
      }

      .submit-btn {
        width: 100%;
        padding: 1rem;
        background: #598392;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .submit-btn:hover {
        background: #124559;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(89, 131, 146, 0.3);
      }

      .submit-btn:disabled {
        background: #95a5a6;
        cursor: not-allowed;
        transform: none;
      }

      .divider {
        text-align: center;
        margin: 1.5rem 0;
        color: #95a5a6;
        position: relative;
        font-size: 0.9rem;
      }

      .divider::before,
      .divider::after {
        content: "";
        position: absolute;
        top: 50%;
        width: 42%;
        height: 1px;
        background: #e0e0e0;
      }

      .divider::before {
        left: 0;
      }

      .divider::after {
        right: 0;
      }

      .google-btn {
        width: 100%;
        padding: 1rem;
        background: white;
        color: #5f6368;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .google-btn:hover {
        background: #f8f9fa;
        border-color: #d0d0d0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .switch-mode {
        text-align: center;
        margin-top: 1.5rem;
        color: #7f8c8d;
      }

      .switch-mode a {
        color: #598392;
        text-decoration: none;
        font-weight: 600;
      }

      .switch-mode a:hover {
        text-decoration: underline;
      }

      .error-message {
        background: #fee;
        color: #e74c3c;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
        font-size: 0.9rem;
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
        font-size: 0.9rem;
      }

      .loading {
        display: none;
        text-align: center;
        margin-top: 1rem;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #598392;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .auth-container {
          flex-direction: column;
        }

        .auth-left {
          padding: 2rem;
        }

        .brand-name {
          font-size: 2rem;
        }

        .feature-item {
          margin-bottom: 1.5rem;
        }

        .auth-right {
          padding: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <!-- Left Side - Branding -->
      <div class="auth-left">
        <div class="brand-header">
          <h1 class="brand-name">ðŸŒ¾ AgroConnect</h1>
          <p class="brand-tagline">The Smart Farm2City Network!</p>
        </div>

        <ul class="features-list">
          <li class="feature-item">
            <div class="feature-icon">ðŸšœ</div>
            <div class="feature-content">
              <h3>Direct Market Access</h3>
              <p>Connect directly with buyers and eliminate middlemen</p>
            </div>
          </li>
          <li class="feature-item">
            <div class="feature-icon">ðŸ’°</div>
            <div class="feature-content">
              <h3>Fair Pricing</h3>
              <p>Get AI-suggested prices and earn what you deserve</p>
            </div>
          </li>
          <li class="feature-item">
            <div class="feature-icon">âœ…</div>
            <div class="feature-content">
              <h3>Build Trust</h3>
              <p>Verified profiles and transparent transactions</p>
            </div>
          </li>
        </ul>
      </div>

      <!-- Right Side - Form -->
      <div class="auth-right">
        <div class="form-header">
          <h2 id="formTitle">Welcome Back!</h2>
          <p id="formSubtitle">Log in to continue your journey</p>
        </div>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <!-- Login Form -->
        <form id="loginForm">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input
              type="email"
              id="loginEmail"
              placeholder="your@email.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input
              type="password"
              id="loginPassword"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            />
          </div>

          <div class="remember-me">
            <input type="checkbox" id="rememberMe" />
            <label for="rememberMe">Remember me</label>
          </div>

          <button type="submit" class="submit-btn">Log In</button>

          <div class="divider">OR</div>

          <button type="button" class="google-btn" onclick="signInWithGoogle()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 18 18"
              style="margin-right: 10px"
            >
              <path
                fill="#4285F4"
                d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
              />
              <path
                fill="#34A853"
                d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
              />
              <path
                fill="#FBBC05"
                d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
              />
              <path
                fill="#EA4335"
                d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
              />
            </svg>
            Continue with Google
          </button>

          <div class="switch-mode">
            Don't have an account?
            <a href="#" onclick="switchToSignup(); return false;">Sign up</a>
          </div>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" style="display: none">
          <div class="form-group">
            <label for="signupName">Full Name</label>
            <input
              type="text"
              id="signupName"
              placeholder="Enter your full name"
              required
            />
          </div>

          <div class="form-group">
            <label for="signupEmail">Email</label>
            <input
              type="email"
              id="signupEmail"
              placeholder="your@email.com"
              required
            />
          </div>

          <div class="form-group">
            <label for="signupPassword">Password</label>
            <input
              type="password"
              id="signupPassword"
              placeholder="At least 6 characters"
              required
              minlength="6"
            />
          </div>

          <button type="submit" class="submit-btn">Create Account</button>

          <div class="divider">OR</div>

          <button type="button" class="google-btn" onclick="signInWithGoogle()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 18 18"
              style="margin-right: 10px"
            >
              <path
                fill="#4285F4"
                d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
              />
              <path
                fill="#34A853"
                d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"
              />
              <path
                fill="#FBBC05"
                d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"
              />
              <path
                fill="#EA4335"
                d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.961L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"
              />
            </svg>
            Continue with Google
          </button>

          <div class="switch-mode">
            Already have an account?
            <a href="#" onclick="switchToLogin(); return false;">Log in</a>
          </div>
        </form>

        <div class="loading">
          <div class="spinner"></div>
          <p>Please wait...</p>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Firebase Config & Auth -->
    <script src="firebase/config.js"></script>
    <script src="firebase/auth.js"></script>
    <script src="firebase/firestore.js"></script>

    <!-- Auth Page Script -->
    <script>
      const loginForm = document.getElementById("loginForm");
      const signupForm = document.getElementById("signupForm");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const loading = document.querySelector(".loading");
      const formTitle = document.getElementById("formTitle");
      const formSubtitle = document.getElementById("formSubtitle");

      // Get role from URL parameter (if coming from homepage buttons)
      const urlParams = new URLSearchParams(window.location.search);
      let userRole = urlParams.get("role") || null;

      // Update UI based on role (only if role is specified)
      if (userRole === "farmer") {
        formTitle.textContent = "Welcome Back Farmer!";
        formSubtitle.textContent = "Log in to manage your stall";
      } else if (userRole === "buyer") {
        formTitle.textContent = "Welcome Back Buyer!";
        formSubtitle.textContent = "Log in to browse products";
      }

      // Switch to signup
      function switchToSignup() {
        loginForm.style.display = "none";
        signupForm.style.display = "block";
        
        if (userRole === "farmer") {
          formTitle.textContent = "Create Farmer Account";
          formSubtitle.textContent = "Start selling your produce directly";
        } else if (userRole === "buyer") {
          formTitle.textContent = "Create Buyer Account";
          formSubtitle.textContent = "Access fresh produce from farmers";
        } else {
          formTitle.textContent = "Create Account";
          formSubtitle.textContent = "Join AgroConnect and start trading";
        }
        hideMessages();
      }

      // Switch to login
      function switchToLogin() {
        loginForm.style.display = "block";
        signupForm.style.display = "none";
        
        if (userRole === "farmer") {
          formTitle.textContent = "Welcome Back Farmer!";
          formSubtitle.textContent = "Log in to manage your stall";
        } else if (userRole === "buyer") {
          formTitle.textContent = "Welcome Back Buyer!";
          formSubtitle.textContent = "Log in to browse products";
        } else {
          formTitle.textContent = "Welcome Back";
          formSubtitle.textContent = "Log in to continue your journey";
        }
        hideMessages();
      }

      // Google Sign-In
      async function signInWithGoogle() {
        hideMessages();
        showLoading();

        try {
          const provider = new firebase.auth.GoogleAuthProvider();
          const result = await auth.signInWithPopup(provider);
          const user = result.user;

          // Check if user exists in Firestore
          const userDoc = await getUserById(user.uid);

          if (!userDoc) {
            // New user - use role from URL
            await db
              .collection("users")
              .doc(user.uid)
              .set({
                uid: user.uid,
                email: user.email,
                displayName: user.displayName,
                role: userRole,
                location: "",
                phone: "",
                verified: userRole === "buyer",
                trustScore: 5.0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

            showSuccess("Account created! Redirecting...");
            setTimeout(() => {
              checkAndRedirect(user.uid);
            }, 1000);
          } else {
            // Existing user
            showSuccess("Login successful! Redirecting...");
            setTimeout(() => {
              checkAndRedirect(user.uid);
            }, 1000);
          }
        } catch (error) {
          showError(error.message);
        } finally {
          hideLoading();
        }
      }

      // Login form submission
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideMessages();
        showLoading();

        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
          const result = await signIn(email, password);

          if (result.success) {
            showSuccess("Login successful! Redirecting...");
            setTimeout(() => {
              checkAndRedirect(result.user.uid);
            }, 1000);
          } else {
            showError(result.error);
          }
        } catch (error) {
          showError(error.message);
        } finally {
          hideLoading();
        }
      });

      // Signup form submission
      signupForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideMessages();
        showLoading();

        const displayName = document.getElementById("signupName").value;
        const email = document.getElementById("signupEmail").value;
        const password = document.getElementById("signupPassword").value;

        try {
          const result = await signUp(email, password, {
            displayName,
            role: userRole,
            location: "",
            phone: "",
          });

          if (result.success) {
            showSuccess("Account created successfully! Redirecting...");
            setTimeout(() => {
              checkAndRedirect(result.user.uid);
            }, 1000);
          } else {
            showError(result.error);
          }
        } catch (error) {
          showError(error.message);
        } finally {
          hideLoading();
        }
      });

      // Check user role and redirect
      async function checkAndRedirect(uid) {
        const userData = await getUserById(uid);
        if (userData) {
          // Redirect to marketplace for all users
          window.location.href = "../MainInterface/marketplace.html";
        }
      }

      // Check if user is already logged in
      onAuthChange(async (user) => {
        if (user) {
          checkAndRedirect(user.uid);
        }
      });

      // Helper functions
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = "block";
      }

      function hideMessages() {
        errorMessage.style.display = "none";
        successMessage.style.display = "none";
      }

      function showLoading() {
        loading.style.display = "block";
        document
          .querySelectorAll(".submit-btn")
          .forEach((btn) => (btn.disabled = true));
      }

      function hideLoading() {
        loading.style.display = "none";
        document
          .querySelectorAll(".submit-btn")
          .forEach((btn) => (btn.disabled = false));
      }
    </script>
  </body>
</html>
